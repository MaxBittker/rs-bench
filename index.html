<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="rs-bench evaluates AI coding agents on their ability to play RuneScape.">
  <meta name="keywords" content="rs-bench, RuneScape, AI benchmark, coding agents">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="views/skill-icons/crafting.png">
  <title>rs-bench: AI Agent Benchmark for RuneScape</title>

  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">

  <style>
    body {
      font-family: 'Noto Sans', sans-serif;
    }

    .link-block a {
      margin-top: 5px;
      margin-bottom: 5px;
    }

    .teaser .hero-body {
      padding-top: 0;
      padding-bottom: 3rem;
    }

    .teaser {
      font-family: 'Google Sans', sans-serif;
    }

    .publication-title {
      font-family: 'Google Sans', sans-serif;
    }

    .publication-authors {
      font-family: 'Google Sans', sans-serif;
    }

    .publication-authors a {
      color: hsl(204, 86%, 53%) !important;
    }

    .publication-authors a:hover {
      text-decoration: underline;
    }

    .author-block {
      display: inline-block;
    }

    .teaser-img {
      display: block;
      width: 100%;
      border-radius: 10px;
    }

    /* Chart styles */
    .benchmark-chart-wrap {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 16px 12px 8px;
    }
    .benchmark-chart-wrap canvas {
      width: 100% !important;
      height: 450px !important;
    }
    .chart-tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(255,255,255,0.97);
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
      padding: 10px 14px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: #333;
      z-index: 2000;
      transition: opacity 0.12s;
      max-width: 260px;
    }
    .chart-tooltip-title {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .chart-tooltip-title img { width: 16px; height: 16px; flex-shrink: 0; }
    .chart-tooltip-avg {
      font-size: 11px;
      color: #666;
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }
    .chart-tooltip-skill {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 1.5px 0;
      font-size: 11px;
      color: #555;
    }
    .chart-tooltip-skill img { width: 14px; height: 14px; flex-shrink: 0; }
    .chart-tooltip-skill .xp { margin-left: auto; font-variant-numeric: tabular-nums; color: #888; }
    .chart-tooltip-skill .xp.zero { color: #ccc; }
    .bottom-legend {
      display: flex;
      gap: 24px;
      padding: 12px 0 4px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #555;
      cursor: pointer;
    }
    .legend-item.hidden { opacity: 0.35; }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .result-card {
      display: block;
      padding: 20px 24px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      text-decoration: none;
      color: #2c3e50;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .result-card:hover {
      border-color: #2196F3;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.12);
      color: #2c3e50;
    }
    .result-card .card-title {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .result-card .card-desc {
      font-size: 0.9em;
      color: #888;
    }

    .feature-box {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 16px 20px;
    }
    .feature-box h4 {
      margin-bottom: 4px;
      font-weight: 600;
    }
    .feature-box p {
      color: #555;
      font-size: 0.95em;
    }

    .footer .icon-link {
      font-size: 25px;
      color: #000;
    }

    /* Heatmap styles */
    .heatmap-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .heatmap-table {
      border-collapse: collapse;
      font-size: 12px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      white-space: nowrap;
      margin: 0 auto;
    }
    .heatmap-table th,
    .heatmap-table td {
      padding: 4px 6px;
      text-align: center;
      border: 1px solid #e8e8e8;
    }
    .heatmap-table thead th {
      background: #fafafa;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .heatmap-table thead th img {
      display: block;
      margin: 0 auto 2px;
    }
    .heatmap-model {
      position: sticky;
      left: 0;
      z-index: 1;
      background: #fff;
      text-align: left !important;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .heatmap-model img {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    .heatmap-model span {
      font-size: 11px;
    }
    .heatmap-total {
      font-weight: 700;
      background: #fafafa !important;
      color: #333 !important;
    }

    /* Trajectory steps */
    .traj-step.agent {
      color: #1a1a1a;
      font-size: 14px;
      line-height: 1.65;
      padding: 10px 0;
      white-space: pre-wrap;
    }
    .traj-step.agent + .traj-step.agent {
      border-top: 1px solid #f0f0f0;
    }
    .traj-tool-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 4px 0;
    }
    .traj-tool-chip {
      display: inline-block;
      font-family: monospace;
      font-size: 10px;
      color: #aaa;
      background: #f5f5f5;
      border-radius: 3px;
      padding: 1px 6px;
      line-height: 1.5;
    }

    /* Skill picker */
    .skill-picker-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      padding: 20px 24px;
    }
    .skill-picker-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border: 1px solid #e8e8e8;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #333;
      transition: border-color 0.15s, background 0.15s;
    }
    .skill-picker-item:hover {
      border-color: #999;
      background: #fafafa;
    }
    .skill-picker-item img {
      width: 16px;
      height: 16px;
    }
    .skill-picker-xp {
      margin-left: auto;
      font-size: 11px;
      font-weight: 400;
      color: #aaa;
    }
    .skill-picker-item.no-traj {
      opacity: 0.4;
      cursor: default;
    }

    /* Clickable heatmap cells */
    .heatmap-table tbody tr { cursor: pointer; }
    .heatmap-table tbody td:not(.heatmap-model):not(.heatmap-total):hover {
      outline: 2px solid #2196F3;
      outline-offset: -2px;
    }

    @media (max-width: 768px) {
      .benchmark-chart-wrap canvas { height: 350px !important; }
      .features-grid { grid-template-columns: 1fr !important; }
      .results-grid { grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>


<section class="hero">
  <div class="hero-body">
    <div class="container is-max-desktop">
      <div class="columns is-centered">
        <div class="column has-text-centered">
          <h1 class="title is-1 publication-title">rs-bench</h1>
          <p class="subtitle is-3" style="margin-top: -0.5rem;">
            AI Agent Benchmark for RuneScape Gameplay Tasks
          </p>

          <div class="is-size-5 publication-authors">
            <span class="author-block">
              <a href="https://maxbittker.com">Max Bittker</a>
            </span>
          </div>

          <div class="column has-text-centered">
            <div class="publication-links">
              <span class="link-block">
                <a href="https://github.com/MaxBittker/rs-bench" target="_blank"
                   class="external-link button is-normal is-rounded is-dark">
                  <span class="icon">
                    <i class="fab fa-github"></i>
                  </span>
                  <span>Code</span>
                </a>
              </span>
              <span class="link-block">
                <a href="https://github.com/MaxBittker/rs-sdk" target="_blank"
                   class="external-link button is-normal is-rounded is-dark">
                  <span class="icon">
                    <img src="views/skill-icons/smithing.png" alt="" style="width: 18px; height: 18px; filter: brightness(0) invert(1);">
                  </span>
                  <span>rs-sdk</span>
                </a>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="hero teaser">
  <div class="container is-max-desktop">
    <div class="hero-body">
      <img class="teaser-img"
           src="https://raw.githubusercontent.com/MaxBittker/rs-sdk/main/server/content/title/promo.gif"
           alt="rs-sdk demo">
      <h2 class="subtitle has-text-centered" style="margin-top: 1rem;">
        Agents write code to play RuneScape &mdash; training skills
        and navigating the game world within fixed time horizons.
      </h2>
    </div>
  </div>
</section>


<section class="section">
  <div class="container is-max-desktop">
    <!-- Abstract -->
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Overview</h2>
        <div class="content has-text-justified">
          <p>
            <strong>rs-bench</strong> evaluates AI coding agents on their ability to play RuneScape.
            Agents are given access to a game environment via
            <a href="https://github.com/MaxBittker/rs-sdk">rs-sdk</a>
            and must write code to accomplish tasks in the game world
            within fixed time horizons.
            The benchmark tests the agent's capabilities in a "observe, orient, decide, act loop" environment, 
            surfacing differences in their multi-step planning and problem solving capabilities.
          </p>
          
        </div>
      </div>
    </div>
    <!--/ Abstract -->
  </div>
</section>


<!-- Embedded 30m benchmark -->
<section class="section">
  <div class="container is-max-widescreen">
    <div class="columns is-centered has-text-centered">
      <div class="column">
        <h2 class="title is-3">Skill XP &mdash; 30 min wall clock</h2>
        <p class="subtitle is-6" style="color: #888;">
          Total XP gained across 16 skills in 30 minutes wall clock (4 hours in-game at 8x speed). Best of 1.
          <a href="views/graph-skills.html?horizon=30m">Full interactive view &rarr;</a>
        </p>
      </div>
    </div>
    <div class="benchmark-chart-wrap">
      <div id="chartContainer"></div>
    </div>
    <div class="bottom-legend" id="chartLegend"></div>
  </div>
</section>


<!-- Performance Heatmap -->
<section class="section">
  <div class="container is-max-widescreen">
    <div class="columns is-centered has-text-centered">
      <div class="column">
        <h2 class="title is-3">Per-Skill Breakdown</h2>
        <p class="subtitle is-6" style="color: #888;">
          Skill level reached per model. Best of 1. Color intensity indicates relative ranking within each skill column.
        </p>
      </div>
    </div>
    <div class="heatmap-scroll">
      <table class="heatmap-table" id="heatmapTable"></table>
    </div>
  </div>
</section>


<!-- Benchmark Design -->
<section class="section">
  <div class="container is-max-desktop">
    <div class="columns is-centered has-text-centered">
      <div class="column">
        <h2 class="title is-3">Benchmark Design</h2>
      </div>
    </div>
    <div class="features-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div class="feature-box">
        <h4 class="title is-5">16 Skills</h4>
        <p>Each RuneScape skill is a separate task, measuring XP gained within 10-minute and 30-minute wall-clock horizons (equivalent to 80 min and 4 hrs in-game at 8x speed).</p>
      </div>
      <div class="feature-box">
        <h4 class="title is-5">Sandboxed Environment</h4>
        <p>Each run uses a fresh Docker container with the game server running at 8x speed (wall-clock horizons of 10&ndash;30 min correspond to 80 min&ndash;4 hrs of in-game time).</p>
      </div>
      <div class="feature-box">
        <h4 class="title is-5">Multi-Model Comparison</h4>
        <p>Run the same tasks across multiple frontier models to compare agent capabilities.</p>
      </div>
    </div>
  </div>
</section>


<footer class="footer">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <div class="content has-text-centered" style="font-size: 0.85em; color: #888;">
          <p>
            rs-bench is built on <a href="https://github.com/MaxBittker/rs-sdk">rs-sdk</a>,
            and <a href="https://github.com/LostCityRS/Server">LostCity</a> engine/client
          </p>
          <p>
            Benchmark inspiration from <a href="https://jackhopkins.github.io/factorio-learning-environment/versions/0.3.0.html">Factorio Learning Environment</a>
            by Jack Hopkins et al.
          </p>
          <p>
            Website template borrowed from <a href="https://nerfies.github.io">Nerfies</a>
            licensed under
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Trajectory modal -->
<div id="trajectoryModal" style="display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,0.45); overflow:auto" onclick="if(event.target===this)closeTrajectory()">
  <div style="max-width:640px; margin:40px auto; background:#fff; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); max-height:calc(100vh - 80px); display:flex; flex-direction:column">
    <div id="trajHeader" style="padding:16px 24px; border-bottom:1px solid #e8e8e8; flex-shrink:0">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3 id="trajTitle" style="font-size:16px; font-weight:600; margin:0"></h3>
        <button onclick="closeTrajectory()" style="background:none; border:none; font-size:20px; cursor:pointer; color:#999; padding:0 4px">&times;</button>
      </div>
      <div id="trajSubtitle" style="font-size:12px; color:#999; margin-top:2px"></div>
    </div>
    <div id="trajSteps" style="padding:16px 24px; overflow-y:auto; flex:1"></div>
  </div>
</div>

<!-- Skill picker modal -->
<div id="skillPickerModal" style="display:none; position:fixed; inset:0; z-index:999; background:rgba(0,0,0,0.45); overflow:auto" onclick="if(event.target===this)closeSkillPicker()">
  <div style="max-width:360px; margin:40px auto; background:#fff; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); max-height:calc(100vh - 80px); display:flex; flex-direction:column">
    <div style="padding:16px 24px; border-bottom:1px solid #e8e8e8; display:flex; justify-content:space-between; align-items:center; flex-shrink:0">
      <h3 id="skillPickerTitle" style="font-size:16px; font-weight:600; margin:0"></h3>
      <button onclick="closeSkillPicker()" style="background:none; border:none; font-size:20px; cursor:pointer; color:#999; padding:0 4px">&times;</button>
    </div>
    <div id="skillPickerGrid" class="skill-picker-grid" style="overflow-y:auto; flex:1"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>window.VIEWS_BASE = 'views/';</script>
<script src="views/shared-constants.js"></script>
<script src="results/skills-30m/_data.js"></script>
<script src="views/cumulative-chart.js"></script>
<script>
  if (window.COMBINED_DATA) {
    renderCumulativeChart({
      canvasContainer: document.getElementById('chartContainer'),
      legendContainer: document.getElementById('chartLegend'),
      data: window.COMBINED_DATA,
      horizonMinutes: 30,
      onClick: function(modelKey) { openSkillPicker(modelKey); },
    });
  }
</script>
<script>
(function() {
  const data = window.COMBINED_DATA;
  if (!data) return;

  const TIERS = {
    zero:   { bg: '#e8e8e8', color: '#aaa' },
    low:    { bg: '#c8e6c9', color: '#2e5e3e' },
    mid:    { bg: '#81c784', color: '#1a3d1f' },
    high:   { bg: '#43a047', color: '#fff' },
  };

  // OSRS XP-to-level: floor(1/4 * sum_{l=1}^{L-1} floor(l + 300 * 2^(l/7)))
  const XP_FOR_LEVEL = [0];
  (function() {
    let total = 0;
    for (let l = 1; l < 99; l++) {
      total += Math.floor(l + 300 * Math.pow(2, l / 7));
      XP_FOR_LEVEL.push(Math.floor(total / 4));
    }
  })();
  function levelForXp(xp) {
    for (let l = XP_FOR_LEVEL.length - 1; l >= 1; l--) {
      if (xp >= XP_FOR_LEVEL[l]) return l + 1;
    }
    return 1;
  }

  // Extract level at the 30-minute mark from samples
  const HORIZON_MS = 30 * 60 * 1000;
  function levelAtHorizon(skillData, skill) {
    if (skillData === undefined || skillData === null) return 1;
    const samples = skillData.samples;
    if (samples === undefined || samples.length === 0) {
      return skillData.finalLevel || 1;
    }
    const skillName = SKILL_DISPLAY[skill];
    let lastLevel = 1;
    for (const s of samples) {
      if (s.elapsedMs > HORIZON_MS) break;
      if (s.skills) {
        for (const [name, d] of Object.entries(s.skills)) {
          if (name.toLowerCase() === skillName.toLowerCase() || name.toLowerCase() === skill) {
            lastLevel = d.level || 1;
          }
        }
      }
    }
    return lastLevel;
  }

  // Build model rows using level at horizon
  const models = Object.keys(data).map(key => {
    const skills = {};
    let totalLevel = 0;
    for (const skill of SKILL_ORDER) {
      const level = levelAtHorizon(data[key]?.[skill], skill);
      skills[skill] = level;
      totalLevel += level;
    }
    return { key, totalLevel, skills };
  });

  // Sort by total level descending
  models.sort((a, b) => b.totalLevel - a.totalLevel);

  // Sort skills by average level: easiest (highest avg) on left, hardest on right
  const skillOrder = SKILL_ORDER.slice().sort((a, b) => {
    const avgA = models.reduce((s, m) => s + m.skills[a], 0) / models.length;
    const avgB = models.reduce((s, m) => s + m.skills[b], 0) / models.length;
    return avgB - avgA;
  });

  // Per-skill tier assignment: within each skill column, rank non-zero values into thirds
  // Level 1 = untrained (grey), >1 = trained
  const tiers = {};
  for (const skill of skillOrder) {
    tiers[skill] = {};
    const trained = models
      .filter(m => m.skills[skill] > 1)
      .map(m => m.skills[skill])
      .sort((a, b) => a - b);

    if (trained.length === 0) {
      models.forEach(m => tiers[skill][m.key] = 'zero');
      continue;
    }

    const thirdLen = Math.max(1, Math.ceil(trained.length / 3));
    const lowMax = trained[thirdLen - 1];
    const midMax = trained[Math.min(thirdLen * 2 - 1, trained.length - 1)];

    for (const m of models) {
      const lvl = m.skills[skill];
      if (lvl <= 1) {
        tiers[skill][m.key] = 'zero';
      } else if (lvl <= lowMax && trained.length > 1) {
        tiers[skill][m.key] = 'low';
      } else if (lvl <= midMax && trained.length > 2) {
        tiers[skill][m.key] = 'mid';
      } else {
        tiers[skill][m.key] = 'high';
      }
    }
  }

  // Render table
  const table = document.getElementById('heatmapTable');
  if (!table) return;

  // Header row
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  const modelTh = document.createElement('th');
  modelTh.textContent = 'Model';
  modelTh.style.textAlign = 'left';
  headerRow.appendChild(modelTh);

  for (const skill of skillOrder) {
    const th = document.createElement('th');
    th.title = SKILL_DISPLAY[skill];
    const img = document.createElement('img');
    img.src = VIEWS_BASE + 'skill-icons/' + skill + '.png';
    img.alt = SKILL_DISPLAY[skill];
    img.width = 16;
    img.height = 16;
    th.appendChild(img);
    headerRow.appendChild(th);
  }

  const totalTh = document.createElement('th');
  totalTh.textContent = 'Total';
  totalTh.style.fontWeight = '700';
  headerRow.appendChild(totalTh);
  thead.appendChild(headerRow);
  table.appendChild(thead);

  // Body rows
  const tbody = document.createElement('tbody');
  for (const m of models) {
    const cfg = MODEL_CONFIG[m.key];
    if (!cfg) continue;

    const tr = document.createElement('tr');
    tr.dataset.modelKey = m.key;

    // Model name cell
    const modelTd = document.createElement('td');
    modelTd.className = 'heatmap-model';
    const icon = document.createElement('img');
    icon.src = cfg.icon;
    icon.alt = '';
    modelTd.appendChild(icon);
    const nameSpan = document.createElement('span');
    nameSpan.textContent = cfg.shortName;
    modelTd.appendChild(nameSpan);
    tr.appendChild(modelTd);

    // Skill cells
    for (const skill of skillOrder) {
      const td = document.createElement('td');
      const lvl = m.skills[skill];
      const tier = tiers[skill][m.key];
      const style = TIERS[tier];
      td.style.background = style.bg;
      td.style.color = style.color;
      td.style.fontVariantNumeric = 'tabular-nums';
      td.textContent = lvl > 1 ? String(lvl) : '1';
      tr.appendChild(td);
    }

    // Total level cell
    const totalTd = document.createElement('td');
    totalTd.className = 'heatmap-total';
    totalTd.textContent = String(m.totalLevel);
    tr.appendChild(totalTd);

    tbody.appendChild(tr);
  }
  table.appendChild(tbody);

  // ── Heatmap click handlers ──────────────────────────────────────
  // Store skillOrder so click handlers can map cell index → skill key
  window._heatmapSkillOrder = skillOrder;
})();
</script>

<script>
// ── Trajectory / Skill Picker ───────────────────────────────────

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function openTrajectory(model, skill) {
  const data = window.COMBINED_DATA?.[model]?.[skill];
  if (!data) return;

  const config = MODEL_CONFIG[model] || { displayName: model, color: '#999' };
  const skillName = SKILL_DISPLAY[skill] || skill;

  document.getElementById('trajTitle').textContent = config.displayName + ' \u2014 ' + skillName;
  document.getElementById('trajSubtitle').textContent =
    formatXp(data.finalXp) + ' XP (Lv ' + data.finalLevel + ')' + (data.jobName ? ' \xb7 ' + data.jobName : '');

  const stepsEl = document.getElementById('trajSteps');
  const steps = data.trajectory || [];
  if (steps.length === 0) {
    stepsEl.innerHTML = '<div style="color:#999; text-align:center; padding:32px">No trajectory data available for this run.</div>';
  } else {
    let html = '';
    let toolBuffer = [];

    function flushTools() {
      if (toolBuffer.length === 0) return;
      html += '<div class="traj-tool-group">';
      for (const t of toolBuffer) {
        const label = t.replace(/^mcp__rs-agent__/, '').replace(/^mcp__\w+__/, '');
        html += '<span class="traj-tool-chip">' + escapeHtml(label) + '</span>';
      }
      html += '</div>';
      toolBuffer = [];
    }

    for (const step of steps) {
      if (step.source === 'tool') {
        toolBuffer.push(step.text);
      } else {
        flushTools();
        html += '<div class="traj-step agent">' + escapeHtml(step.text) + '</div>';
      }
    }
    flushTools();
    stepsEl.innerHTML = html;
  }

  document.getElementById('trajectoryModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeTrajectory() {
  document.getElementById('trajectoryModal').style.display = 'none';
  document.body.style.overflow = '';
}

function openSkillPicker(model) {
  const config = MODEL_CONFIG[model] || { displayName: model, color: '#999' };
  document.getElementById('skillPickerTitle').textContent = config.displayName;

  const grid = document.getElementById('skillPickerGrid');
  let html = '';
  for (const skill of SKILL_ORDER) {
    const sd = window.COMBINED_DATA?.[model]?.[skill];
    const xp = sd?.finalXp || 0;
    const hasTraj = sd?.trajectory?.length > 0;
    const iconSrc = VIEWS_BASE + 'skill-icons/' + skill + '.png';
    html += '<div class="skill-picker-item' + (hasTraj ? '' : ' no-traj') + '"'
      + ' onclick="' + (hasTraj ? "closeSkillPicker();openTrajectory('" + model + "','" + skill + "')" : '') + '"'
      + (hasTraj ? '' : ' style="opacity:0.4;cursor:default"') + '>'
      + '<img src="' + iconSrc + '" onerror="this.style.display=\'none\'">'
      + (SKILL_DISPLAY[skill] || skill)
      + '<span class="skill-picker-xp">' + (xp > 0 ? formatXp(xp) : '-') + '</span>'
      + '</div>';
  }
  grid.innerHTML = html;
  document.getElementById('skillPickerModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeSkillPicker() {
  document.getElementById('skillPickerModal').style.display = 'none';
  document.body.style.overflow = '';
}

// Close modals on Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeTrajectory();
    closeSkillPicker();
  }
});

// ── Heatmap click handlers ──────────────────────────────────────
(function() {
  const table = document.getElementById('heatmapTable');
  if (!table) return;
  const data = window.COMBINED_DATA;
  if (!data) return;

  const skillOrder = window._heatmapSkillOrder;
  if (!skillOrder) return;

  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(function(tr) {
    const modelKey = tr.dataset.modelKey;
    if (!modelKey) return;

    // Click on model name cell -> open skill picker
    const modelCell = tr.querySelector('.heatmap-model');
    if (modelCell) {
      modelCell.style.cursor = 'pointer';
      modelCell.addEventListener('click', function(e) {
        e.stopPropagation();
        openSkillPicker(modelKey);
      });
    }

    // Click on individual skill cells -> open trajectory directly
    const cells = tr.querySelectorAll('td');
    cells.forEach(function(td, cellIdx) {
      // cellIdx 0 = model name, last = total; skill cells are 1..skillOrder.length
      if (cellIdx === 0 || cellIdx > skillOrder.length) return;
      const skill = skillOrder[cellIdx - 1];
      td.style.cursor = 'pointer';
      td.addEventListener('click', function(e) {
        e.stopPropagation();
        const sd = data[modelKey]?.[skill];
        if (sd?.trajectory?.length > 0) {
          openTrajectory(modelKey, skill);
        } else {
          openSkillPicker(modelKey);
        }
      });
    });
  });
})();
</script>
</body>
</html>
